<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Live GPS Tracker (Smooth + Time Filter)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    html, body {
      margin: 0;
      height: 100%;
      font-family: Arial, sans-serif;
    }
    #map {
      width: 100%;
      height: 100%;
    }
    .info-box {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.95);
      padding: 10px 12px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
      font-size: 14px;
    }
    input {
      margin: 4px 0;
      padding: 4px;
      width: 160px;
    }
    button {
      margin-top: 5px;
      padding: 6px 10px;
    }
  </style>
</head>
<body>

<div class="info-box">
  <b>Live GPS Map</b><br>

  <label>User ID:</label><br>
  <input id="userId" type="text" value="user1"><br>

  <label>Start:</label><br>
  <input id="startTime" type="datetime-local"><br>

  <label>End:</label><br>
  <input id="endTime" type="datetime-local"><br>

  <button onclick="loadHistory()">Load Range</button>
  <small id="lastUpdate" style="display:block;margin-top:4px;color:#666;"></small>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>

let map, polyline, trailCoords = [], liveMarker = null;
let lastId = 0;  // for incremental updates
let autoRefreshInterval = 8000; // 8 seconds (configurable)
let userId = "user1";

// ---------------------------
// INIT MAP
// ---------------------------
function initMap() {
  map = L.map('map').setView([20.5937, 78.9629], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // live incremental updates every 8s
  setInterval(() => loadLiveUpdates(), autoRefreshInterval);
}


// ---------------------------
// LOAD FULL HISTORY (with time filter)
// Clears map + draws all points
// ---------------------------
async function loadHistory() {
  userId = document.getElementById("userId").value || "user1";
  const start = document.getElementById("startTime").value;
  const end = document.getElementById("endTime").value;

  let url = `/get_locations?user_id=${userId}`;

  if (start) url += `&start=${start}`;
  if (end) url += `&end=${end}`;

  console.log("Loading:", url);

  const resp = await fetch(url);
  const data = await resp.json();

  trailCoords = [];
  lastId = 0;

  // Clear old map layers
  if (polyline) polyline.remove();
  if (liveMarker) liveMarker.remove();

  if (!data.length) {
    alert("No data found for selected time range.");
    return;
  }

  // Fill trail
  data.forEach(p => {
    trailCoords.push([p.lat, p.lng]);
    lastId = p.id;   // track highest ID
  });

  drawPolyline();
  placeMarker(trailCoords[trailCoords.length - 1]);

  document.getElementById("lastUpdate").innerText =
    "Loaded " + data.length + " points | Last ID: " + lastId;
}


// ---------------------------
// INCREMENTAL LIVE UPDATE
// ONLY fetch new points using after_id
// ---------------------------
async function loadLiveUpdates() {
  if (!lastId) return; // loadHistory not called yet â†’ do nothing

  userId = document.getElementById("userId").value || "user1";

  const url = `/get_locations?user_id=${userId}&after_id=${lastId}`;
  const resp = await fetch(url);
  const newPoints = await resp.json();

  if (!newPoints.length) return;

  // add new points
  newPoints.forEach(p => {
    trailCoords.push([p.lat, p.lng]);
    lastId = p.id;
  });

  drawPolyline();
  animateMarker(trailCoords[trailCoords.length - 1]);

  document.getElementById("lastUpdate").innerText =
    "Updated @ " + new Date().toLocaleTimeString();
}


// ---------------------------
// DRAW / UPDATE POLYLINE
// ---------------------------
function drawPolyline() {
  if (!polyline) {
    polyline = L.polyline(trailCoords, {
      color: 'blue',
      weight: 4,
      opacity: 0.8
    }).addTo(map);
  } else {
    polyline.setLatLngs(trailCoords);
  }
}


// ---------------------------
// FIRST MARKER
// ---------------------------
function placeMarker(latlng) {
  liveMarker = L.circleMarker(latlng, {
    radius: 8,
    fillColor: 'red',
    color: 'white',
    weight: 2,
    fillOpacity: 1
  }).addTo(map);

  map.flyTo(latlng, 16, { duration: 2 });
}


// ---------------------------
// SMOOTH MOVEMENT ANIMATION
// ---------------------------
function animateMarker(newLatLng) {
  if (!liveMarker) return placeMarker(newLatLng);

  const start = liveMarker.getLatLng();
  const end = L.latLng(newLatLng[0], newLatLng[1]);
  const durationMs = 2000;

  const startTime = performance.now();

  function animate(now) {
    let t = Math.min((now - startTime) / durationMs, 1);
    const lat = start.lat + (end.lat - start.lat) * t;
    const lng = start.lng + (end.lng - start.lng) * t;

    liveMarker.setLatLng([lat, lng]);

    if (t < 1) requestAnimationFrame(animate);
  }

  requestAnimationFrame(animate);
}


// Start map
initMap();

</script>
</body>
</html>
