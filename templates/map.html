<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Live GPS Tracker (Smooth + Time Filter)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    html, body {
      margin: 0;
      height: 100%;
      font-family: Arial, sans-serif;
    }
    #map {
      width: 100%;
      height: 100%;
    }

    .info-box {
      position: absolute;
      top: 10px;
      right: 10px; /* moved away from zoom buttons */
      z-index: 1000;
      background: rgba(255, 255, 255, 0.95);
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
      font-size: 14px;
      width: 220px;
    }
    input {
      margin: 4px 0;
      padding: 4px;
      width: 180px;
    }
    button {
      margin-top: 6px;
      padding: 6px 10px;
      width: 100%;
    }
  </style>
</head>

<body>

<!-- TOP RIGHT CONTROL PANEL -->
<div class="info-box">
  <b>GPS Tracking</b><br><br>

  <label>User ID:</label><br>
  <input id="userId" type="text" value="user1"><br><br>

  <b>Live Tracking</b><br>
  <button onclick="startLiveTracking()">Load Live</button>
  <br>
  <label><input type="checkbox" id="followToggle" checked>
  Follow Marker</label>
  <br><br>

  <br><br>

  <b>History Range</b><br>

  <label>Start:</label><br>
  <input id="startTime" type="datetime-local"><br>

  <label>End:</label><br>
  <input id="endTime" type="datetime-local"><br>

  <button onclick="loadHistory()">Load Range</button>

  <small id="lastUpdate" 
        style="display:block;margin-top:6px;color:#666;"></small>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
/* ============================
      GLOBAL VARIABLES
============================ */
let map, polyline, trailCoords = [], liveMarker = null;
const carIcon = L.icon({
  iconUrl: "https://cdn-icons-png.flaticon.com/512/744/744465.png",
  iconSize: [40, 40],    // adjust size
  iconAnchor: [20, 20],  // center icon
});
let lastId = 0;  
let autoRefreshInterval = 8000; 
let userId = "user1";
let liveMode = false;    // IMPORTANT FIX

/* ============================
          INIT MAP
============================ */
function initMap() {
  map = L.map('map').setView([20.5937, 78.9629], 5);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // Only update when in live mode
  setInterval(() => {
    if (liveMode) loadLiveUpdates();
  }, autoRefreshInterval);
}

/* ============================
   LOAD HISTORY (FULL RANGE)
============================ */
async function loadHistory() {
  liveMode = false;  // STOP LIVE UPDATES

  userId = document.getElementById("userId").value || "user1";
  const start = document.getElementById("startTime").value;
  const end   = document.getElementById("endTime").value;

  let url = `/get_locations?user_id=${userId}&limit=5000`;
  if (start) url += `&start=${start}`;
  if (end)   url += `&end=${end}`;

  console.log("Loading history:", url);

  const resp = await fetch(url);
  const data = await resp.json();

  trailCoords = [];
  lastId = 0;

  if (polyline) polyline.remove();
  if (liveMarker) liveMarker.remove();

  if (!data.length) {
    alert("No data found for this range");
    return;
  }

  data.forEach(p => {
    trailCoords.push([p.lat, p.lng]);
    lastId = p.id;
  });

  drawPolyline();
  placeMarker(trailCoords.at(-1));

  document.getElementById("lastUpdate").innerText =
    `Loaded ${data.length} points | Last ID: ${lastId}`;
}

/* ============================
     LOAD LIVE MODE
============================ */
function startLiveTracking() {
  liveMode = true;

  userId = document.getElementById("userId").value || "user1";

  trailCoords = [];
  lastId = 0;

  if (polyline) polyline.remove();
  if (liveMarker) liveMarker.remove();

  // Load ONLY 2000 points for performance
  fetch(`/get_locations?user_id=${userId}&limit=2000`)
    .then(res => res.json())
    .then(data => {
      if (!data.length) {
        alert("No data found for this user");
        return;
      }

      data.forEach(p => {
        trailCoords.push([p.lat, p.lng]);
        lastId = p.id;
      });

      drawPolyline();
      placeMarker(trailCoords.at(-1));

      document.getElementById("lastUpdate").innerText =
        `Live tracking started | Last ID: ${lastId}`;

      loadLiveUpdates();  // IMMEDIATE UPDATE
    });
}

/* ============================
    INCREMENTAL LIVE UPDATE
============================ */
async function loadLiveUpdates() {
  if (!lastId || !liveMode) return;

  const url = `/get_locations?user_id=${userId}&after_id=${lastId}`;
  const resp = await fetch(url);
  const newPoints = await resp.json();

  if (!newPoints.length) return;

  newPoints.forEach(p => {
    trailCoords.push([p.lat, p.lng]);
    lastId = p.id;
  });

  drawPolyline();
  animateMarker(trailCoords.at(-1));

  document.getElementById("lastUpdate").innerText =
    "Updated @ " + new Date().toLocaleTimeString();
}

/* ============================
     DRAW / UPDATE POLYLINE
============================ */
function drawPolyline() {
  if (!polyline) {
    polyline = L.polyline(trailCoords, {
      color: 'blue',
      weight: 4,
      opacity: 0.8
    }).addTo(map);
  } else {
    polyline.setLatLngs(trailCoords);
  }
}

/* ============================
     PLACE STATIC MARKER
============================ */
function placeMarker(latlng) {
  liveMarker = L.marker(latlng, { icon: carIcon }).addTo(map);
  map.flyTo(latlng, 16, { duration: 2 });
}


/* ============================
   SMOOTH MARKER MOVEMENT
============================ */
function animateMarker(newLatLng) {
  if (!liveMarker) return placeMarker(newLatLng);

  const start = liveMarker.getLatLng();
  const end   = L.latLng(newLatLng[0], newLatLng[1]);
  const durationMs = 2000;

  const startTime = performance.now();
  
  function animate(now) {
    let t = Math.min((now - startTime) / durationMs, 1);

const lat = start.lat + (end.lat - start.lat) * t;
const lng = start.lng + (end.lng - start.lng) * t;

liveMarker.setLatLng([lat, lng]);
const angle = Math.atan2(end.lng - start.lng, end.lat - start.lat) * (180 / Math.PI);
liveMarker._icon.style.transform = `rotate(${angle}deg)`;

if (document.getElementById("followToggle")?.checked) {
    map.panTo([lat, lng], { animate: true });
}
    if (t < 1) requestAnimationFrame(animate);
  }

  requestAnimationFrame(animate);
}

/* ============================
     LAUNCH MAP
============================ */
document.addEventListener("visibilitychange", () => {
  if (document.hidden) {
    liveMode = false;     // stop auto updates
  } else {
    // resume only if we were in live mode earlier
    if (lastId !== 0) liveMode = true;
  }
});

initMap();

</script>
</body>
</html>
